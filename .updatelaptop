#!/bin/sh

set -e

FILE_PATH=$0
if [[ -h "$FILE_PATH" ]]; then
    FILE_PATH=$(readlink $FILE_PATH)
fi
REPO_DIR=$(dirname  $FILE_PATH)
cd "$REPO_DIR"

# Make sure only one update process is running
LOCK_FILE=".lock"
if [[ -e $LOCK_FILE ]]; then
    exit
fi
function clear_lock {
    rm $LOCK_FILE
}
trap clear_lock EXIT
touch $LOCK_FILE

# Check if already updated in the last 24 hours
CURRENT_TIME=$(date +%s)
LAST_UPDATE_TIME=0
UPDATE_INTERVAL=86400
LAST_UPDATE_TIME_FILE=".last-update-time"

if [[ -e $LAST_UPDATE_TIME_FILE ]]; then
    LAST_UPDATE_TIME=$(cat $LAST_UPDATE_TIME_FILE)
fi

TIME_SINCE_LAST_UPDATE=$(( CURRENT_TIME - LAST_UPDATE_TIME ))

if [[ $TIME_SINCE_LAST_UPDATE -lt $UPDATE_INTERVAL ]]; then
    exit
fi

if [[ "$LAST_UPDATE_TIME" -gt 0 ]]; then
    echo "Last update was $(( $TIME_SINCE_LAST_UPDATE / 86400 )) days ago"
fi

# Update the repo
git pull

# Run the update
python3 update.py

# Update the last updated timestamp
echo "$CURRENT_TIME" > "$LAST_UPDATE_TIME_FILE"