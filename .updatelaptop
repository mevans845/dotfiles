#!/bin/sh

set -e

LAST_UPDATE_HASH=".last-update-hash"
LOCK_FILE=".lock"

file_path=$0
if [[ -h "$file_path" ]]; then
    file_path=$(readlink $file_path)
fi
cd $(dirname  $file_path)

# Make sure only one update process is running
if [[ -e $LOCK_FILE ]]; then
    exit
fi
function clear_lock {
    rm $LOCK_FILE
}
trap clear_lock EXIT
touch $LOCK_FILE

# Update the repo
git pull

# Check if there are new updates to the repo
last_update_hash=""
if [[ -e $LAST_UPDATE_HASH ]]; then
    last_update_hash=$(cat $LAST_UPDATE_HASH)
fi
current_hash=$(git rev-parse HEAD)
if [[ "$last_update_hash" == "$current_hash" ]]; then
    exit
fi

# Run the update
python3 update.py

# Update the last updated timestamp
echo "$current_hash" > "$LAST_UPDATE_HASH"